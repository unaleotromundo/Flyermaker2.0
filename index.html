<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creador de Catálogos</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Cropper.js CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #e2e8f0;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        /* Style for the + icon on logo upload */
        .logo-upload-area {
            position: relative;
            cursor: pointer;
            border: 2px dashed #cbd5e1;
        }
        .logo-upload-area::after {
            content: '+';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3rem;
            color: #94a3b8;
            pointer-events: none;
            opacity: 0.7;
            z-index: 10;
        }
        .logo-upload-area.has-image::after {
            content: '';
        }
        .logo-upload-area img {
            position: relative;
            z-index: 5;
        }
        .logo-upload-area.has-image img {
            z-index: 15;
        }

        /* Enhanced Catalog Preview Styles */
        #catalogPreview {
            background-color: #ffffff;
            padding: 2.5rem; /* Increased padding */
            border-radius: 1.5rem; /* More rounded corners */
            box-shadow: 0 15px 25px -5px rgba(0, 0, 0, 0.1), 0 6px 15px -3px rgba(0, 0, 0, 0.05); /* Stronger shadow */
            min-height: 500px; /* Ensure enough space */
            display: flex; /* Use flexbox for main layout */
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        #previewStoreName {
            font-size: 3.5rem; /* Larger font for store name */
            font-weight: 800; /* Extra bold */
            color: #1a202c; /* Darker text */
            margin-bottom: 0.5rem;
            line-height: 1.1;
        }

        #previewSlogan {
            font-size: 1.25rem;
            color: #4a5568;
            margin-top: 0.5rem;
            font-style: italic;
        }

        #previewPhoneNumber,
        #previewEmail,
        #previewWebsite {
            color: #4a5568; /* Slightly darker gray for contact info */
            font-size: 0.95rem; /* Slightly larger font */
            margin-top: 0.25rem;
        }
        #previewWebsite {
            color: #3b82f6; /* Blue for links */
        }

        #previewProducts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); /* Responsive grid */
            gap: 2rem; /* More space between product cards */
            width: 100%;
            margin-top: 2rem;
        }

        .product-card-preview {
            background-color: #f8fafc; /* Lighter background for product cards */
            padding: 1.5rem; /* More padding */
            border-radius: 1rem; /* Rounded corners */
            box-shadow: 0 5px 10px -2px rgba(0, 0, 0, 0.05), 0 2px 5px -1px rgba(0, 0, 0, 0.02); /* Subtle shadow */
            border: 1px solid #e2e8f0; /* Light border */
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .product-card-preview img {
            width: 100%;
            height: 200px; /* Fixed height for consistency */
            object-contain; /* Ensure image is not distorted */
            border-radius: 0.75rem; /* Rounded image corners */
            margin-bottom: 1rem;
            background-color: #ffffff; /* White background for images */
            padding: 0.5rem; /* Small padding inside image container */
            border: 1px solid #edf2f7; /* Light border for image */
        }

        .product-card-preview h4 {
            font-size: 1.5rem; /* Larger product name */
            font-weight: 700; /* Bold */
            color: #2d3748; /* Darker text */
            margin-bottom: 0.5rem;
        }

        .product-card-preview p:nth-of-type(1) { /* Price */
            font-size: 1.75rem; /* Larger price */
            font-weight: 800; /* Extra bold */
            color: #2563eb; /* Stronger blue for price */
            margin-bottom: 0.75rem;
        }

        .product-card-preview p:nth-of-type(2) { /* Description */
            color: #4a5568; /* Darker gray for description */
            font-size: 1rem; /* Standard font size */
            line-height: 1.5;
        }
        .product-card-preview .tags {
            font-size: 0.85rem;
            color: #6b7280;
            margin-top: 0.5rem;
            font-style: italic;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center py-8 px-4">

    <!-- Main Container -->
    <div class="bg-white rounded-xl shadow-lg p-8 max-w-4xl w-full mb-8">
        <h1 class="text-4xl font-bold text-center text-gray-800 mb-8">Crea tu Catálogo Promocional</h1>

        <!-- Loading Indicator -->
        <div id="loading-spinner" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50">
            <div class="animate-spin rounded-full h-20 w-20 border-t-4 border-b-4 border-blue-500"></div>
            <p class="text-white text-lg ml-4">Generando...</p>
        </div>

        <!-- Catalog Form -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div class="space-y-6">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">Detalles de la Tienda</h2>
                <div>
                    <label for="storeName" class="block text-sm font-medium text-gray-700 mb-1">Nombre de la Tienda</label>
                    <input type="text" id="storeName" placeholder="Ej. Mi Tienda Online"
                           class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                           oninput="updatePreview()">
                </div>
                <div>
                    <label for="storeSlogan" class="block text-sm font-medium text-gray-700 mb-1">Eslogan de la Tienda</label>
                    <div class="flex gap-2">
                        <input type="text" id="storeSlogan" placeholder="Ej. Tu estilo, tu esencia."
                               class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                               oninput="updatePreview()">
                        <button type="button" onclick="generateStoreSlogan()"
                                class="bg-yellow-500 text-white py-2 px-4 rounded-md hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-offset-2 transition duration-150 ease-in-out text-sm">
                            Generar Eslogan ✨
                        </button>
                    </div>
                </div>
                <div>
                    <label for="logoUpload" class="block text-sm font-medium text-gray-700 mb-1">Logo de la Empresa</label>
                    <input type="file" id="logoUpload" accept="image/*" class="hidden"
                           onchange="handleImageUpload(event, 'logoPreview', 'logoUploadArea')">
                    <div id="logoUploadArea" class="mt-2 w-24 h-24 border border-gray-300 rounded-md flex items-center justify-center overflow-hidden logo-upload-area"
                         onclick="document.getElementById('logoUpload').click()">
                        <img id="logoPreview" src="https://placehold.co/96x96/e0e7ff/4338ca?text=Logo" alt="Vista previa del logo" class="max-w-full max-h-full object-contain">
                    </div>
                    <button type="button" onclick="showGenerateLogoModal()"
                            class="w-full bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-150 ease-in-out mt-2">
                        Generar Logo con IA ✨
                    </button>
                </div>
                
                <!-- New Contact Info Fields -->
                <div>
                    <label for="phoneNumber" class="block text-sm font-medium text-gray-700 mb-1">Número de Teléfono</label>
                    <div class="flex gap-2">
                        <input type="tel" id="phoneNumber" placeholder="Ej. +598 99 123 456"
                               class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                               oninput="updatePreview()">
                        <button type="button" onclick="generatePhoneNumberQR()"
                                class="bg-green-500 text-white py-2 px-4 rounded-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-150 ease-in-out text-sm">
                            Generar QR WhatsApp 💬
                        </button>
                    </div>
                </div>
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Correo Electrónico</label>
                    <input type="email" id="email" placeholder="Ej. info@mitienda.com"
                           class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                           oninput="updatePreview()">
                </div>
                <div>
                    <label for="website" class="block text-sm font-medium text-gray-700 mb-1">Sitio Web / Red Social</label>
                    <input type="url" id="website" placeholder="Ej. www.mitienda.com o facebook.com/mitienda"
                           class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                           oninput="updatePreview()">
                </div>

                <h2 class="text-2xl font-semibold text-gray-700 mb-4 mt-8">Productos</h2>
                <div id="productsContainer" class="space-y-6">
                    <!-- Product input fields will be added here dynamically -->
                </div>
                <button type="button" onclick="addProduct()"
                        class="w-full bg-green-500 text-white py-2 px-4 rounded-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                    + Añadir Producto
                </button>
            </div>

            <!-- Catalog Preview -->
            <div class="bg-gray-50 rounded-lg p-6 shadow-inner border border-gray-200">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">Vista Previa del Catálogo</h2>
                <div id="catalogPreview" class="bg-white p-6 rounded-lg shadow-md border border-gray-100 min-h-[400px]">
                    <!-- Header Section -->
                    <div class="flex flex-col items-center justify-center mb-8">
                        <img id="previewLogo" src="https://placehold.co/120x120/e0e7ff/4338ca?text=Logo" alt="Logo de la tienda" class="w-32 h-32 object-contain rounded-full border-4 border-blue-200 p-1 mb-4">
                        <h3 id="previewStoreName" class="text-4xl font-extrabold text-gray-900 mb-2">Nombre de la Tienda</h3>
                        <p id="previewSlogan" class="text-gray-700 text-lg mt-1"></p>
                        <p id="previewPhoneNumber" class="text-gray-700 text-base mt-1"></p>
                        <p id="previewEmail" class="text-gray-700 text-base"></p>
                        <a id="previewWebsite" href="#" target="_blank" class="text-blue-600 text-base hover:underline mt-1"></a>
                    </div>
                    <!-- Products Grid -->
                    <div id="previewProducts" class="grid grid-cols-1 sm:grid-cols-2 gap-8">
                        <!-- Product previews will be added here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="mt-8 flex flex-col sm:flex-row justify-center gap-4">
            <button id="saveCatalogBtn"
                    class="bg-blue-600 text-white py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-150 ease-in-out font-semibold text-lg">
                Guardar Catálogo
            </button>
            <button id="generatePdfBtn"
                    class="bg-red-600 text-white py-3 px-6 rounded-lg shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition duration-150 ease-in-out font-semibold text-lg">
                Generar PDF
            </button>
            <button id="generateImageBtn"
                    class="bg-purple-600 text-white py-3 px-6 rounded-lg shadow-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition duration-150 ease-in-out font-semibold text-lg">
                Generar Imagen
            </button>
            <button type="button" onclick="summarizeCatalog()"
                    class="bg-orange-500 text-white py-3 px-6 rounded-lg shadow-md hover:bg-orange-600 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-offset-2 transition duration-150 ease-in-out font-semibold text-lg">
                Resumir Catálogo ✨
            </button>
        </div>

        <!-- Message Box -->
        <div id="messageBox" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-8 shadow-xl max-w-sm w-full text-center">
                <p id="messageText" class="text-lg font-semibold text-gray-800 mb-6"></p>
                <button onclick="hideMessageBox()" class="bg-blue-500 text-white py-2 px-6 rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    Aceptar
                </button>
            </div>
        </div>

        <!-- Social Media Post Modal -->
        <div id="socialMediaPostModal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-8 shadow-xl max-w-lg w-full">
                <h3 class="text-2xl font-semibold text-gray-800 mb-4">Publicación para Redes Sociales</h3>
                <textarea id="socialMediaPostContent" rows="8" class="w-full p-3 border border-gray-300 rounded-md mb-4 text-gray-700" readonly></textarea>
                <div class="flex justify-end gap-3">
                    <button onclick="copySocialMediaPost()" class="bg-green-500 text-white py-2 px-4 rounded-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                        Copiar
                    </button>
                    <button onclick="hideSocialMediaPostModal()" class="bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                        Cerrar
                    </button>
                </div>
            </div>
        </div>

        <!-- QR Code Modal -->
        <div id="qrCodeModal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-8 shadow-xl max-w-sm w-full text-center">
                <h3 class="text-2xl font-semibold text-gray-800 mb-4">Código QR para WhatsApp</h3>
                <div id="qrCodeContainer" class="flex justify-center mb-6">
                    <!-- QR code will be rendered here -->
                </div>
                <p class="text-gray-600 text-sm mb-4">Escanea para iniciar un chat de WhatsApp con la tienda.</p>
                <div class="flex flex-col gap-3">
                    <button onclick="copyQrCodeImage()" class="bg-green-500 text-white py-2 px-4 rounded-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                        Copiar Imagen QR
                    </button>
                    <button onclick="downloadQrCodeImage()" class="bg-purple-500 text-white py-2 px-4 rounded-md hover:bg-purple-600 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2">
                        Descargar Imagen QR
                    </button>
                    <button onclick="hideQrCodeModal()" class="bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                        Cerrar
                    </button>
                </div>
            </div>
        </div>

        <!-- Catalog Summary Modal -->
        <div id="catalogSummaryModal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-8 shadow-xl max-w-lg w-full">
                <h3 class="text-2xl font-semibold text-gray-800 mb-4">Resumen del Catálogo</h3>
                <textarea id="catalogSummaryContent" rows="8" class="w-full p-3 border border-gray-300 rounded-md mb-4 text-gray-700" readonly></textarea>
                <div class="flex justify-end gap-3">
                    <button onclick="copyCatalogSummary()" class="bg-green-500 text-white py-2 px-4 rounded-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                        Copiar
                    </button>
                    <button onclick="hideCatalogSummaryModal()" class="bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                        Cerrar
                    </button>
                </div>
            </div>
        </div>

        <!-- Generate Logo Modal -->
        <div id="generateLogoModal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-8 shadow-xl max-w-sm w-full">
                <h3 class="text-2xl font-semibold text-gray-800 mb-4">Generar Logo con IA</h3>
                <div class="mb-4">
                    <label for="logoDescription" class="block text-sm font-medium text-gray-700 mb-1">Describe el logo deseado:</label>
                    <textarea id="logoDescription" rows="3" placeholder="Ej. Un logo minimalista con un árbol y colores verdes."
                              class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></textarea>
                </div>
                <div class="flex justify-end gap-3">
                    <button onclick="generateAILogo()" class="bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                        Generar
                    </button>
                    <button onclick="hideGenerateLogoModal()" class="bg-gray-300 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-offset-2">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>

        <!-- Image Cropping Modal -->
        <div id="imageCropModal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-8 shadow-xl max-w-2xl w-full">
                <h3 class="text-2xl font-semibold text-gray-800 mb-4">Recortar Imagen</h3>
                <div class="w-full h-96 flex items-center justify-center bg-gray-100 overflow-hidden mb-4">
                    <img id="imageToCrop" src="" alt="Imagen a recortar" class="max-w-full max-h-full block">
                </div>
                <div class="flex justify-end gap-3">
                    <button onclick="cropAndApplyImage()" class="bg-green-500 text-white py-2 px-4 rounded-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                        Recortar y Aplicar
                    </button>
                    <button onclick="cancelImageCrop()" class="bg-gray-300 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-offset-2">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>

    </div>

    <!-- Firebase SDK -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";


        // Global variables for Firebase
        let app;
        let db;
        let auth;
        let userId;
        let isAuthReady = false;

        // Cropper.js instance and related variables
        let cropper;
        let currentImagePreviewId;
        let currentImageUploadAreaId;

        // --- Configuración del backend ---
        // CORRECCIÓN: Se cambió la ruta relativa a la URL absoluta de Vercel.
        const BACKEND_URL = 'https://tucatalogo.vercel.app/api';

        // Message box functions
        function showMessageBox(message) {
            document.getElementById('messageText').innerText = message;
            document.getElementById('messageBox').classList.remove('hidden');
        }

        window.hideMessageBox = function() { // Expose to window for onclick
            document.getElementById('messageBox').classList.add('hidden');
        }

        function showSocialMediaPostModal(content) {
            document.getElementById('socialMediaPostContent').value = content;
            document.getElementById('socialMediaPostModal').classList.remove('hidden');
        }

        window.hideSocialMediaPostModal = function() { // Expose to window for onclick
            document.getElementById('socialMediaPostModal').classList.add('hidden');
        }

        window.copySocialMediaPost = function() {
            const textarea = document.getElementById('socialMediaPostContent');
            textarea.select();
            document.execCommand('copy');
            showMessageBox('¡Publicación copiada al portapapeles!');
        }

        // QR Code Modal Functions
        function showQrCodeModal() {
            document.getElementById('qrCodeModal').classList.remove('hidden');
        }

        window.hideQrCodeModal = function() {
            document.getElementById('qrCodeModal').classList.add('hidden');
        }

        window.copyQrCodeImage = function() {
            const qrCanvas = document.querySelector('#qrCodeContainer canvas');
            if (qrCanvas) {
                qrCanvas.toBlob(function(blob) {
                    const item = new ClipboardItem({ "image/png": blob });
                    navigator.clipboard.write([item]).then(function() {
                        showMessageBox('¡Imagen QR copiada al portapapeles!');
                    }, function(error) {
                        console.error('Error al copiar imagen QR:', error);
                        showMessageBox('Error al copiar imagen QR. Asegúrese de que su navegador lo permita.');
                    });
                });
            } else {
                showMessageBox('No se encontró el código QR para copiar.');
            }
        }

        window.downloadQrCodeImage = function() {
            const qrCanvas = document.querySelector('#qrCodeContainer canvas');
            if (qrCanvas) {
                const link = document.createElement('a');
                link.href = qrCanvas.toDataURL('image/png');
                link.download = 'qr_whatsapp.png'; // Changed download name
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showMessageBox('¡Imagen QR descargada con éxito!');
            } else {
                showMessageBox('No se encontró el código QR para descargar.');
            }
        }

        // Catalog Summary Modal Functions
        function showCatalogSummaryModal(content) {
            document.getElementById('catalogSummaryContent').value = content;
            document.getElementById('catalogSummaryModal').classList.remove('hidden');
        }

        window.hideCatalogSummaryModal = function() {
            document.getElementById('catalogSummaryModal').classList.add('hidden');
        }

        window.copyCatalogSummary = function() {
            const textarea = document.getElementById('catalogSummaryContent');
            textarea.select();
            document.execCommand('copy');
            showMessageBox('¡Resumen copiado al portapapeles!');
        }

        // Generate Logo Modal Functions
        window.showGenerateLogoModal = function() {
            document.getElementById('generateLogoModal').classList.remove('hidden');
        }

        window.hideGenerateLogoModal = function() {
            document.getElementById('generateLogoModal').classList.add('hidden');
        }

        // Image Cropping Modal Functions
        function showImageCropModal() {
            document.getElementById('imageCropModal').classList.remove('hidden');
        }

        window.hideImageCropModal = function() {
            document.getElementById('imageCropModal').classList.add('hidden');
            if (cropper) {
                cropper.destroy(); // Destroy cropper instance when hiding modal
                cropper = null;
            }
        }

        window.cropAndApplyImage = function() {
            if (cropper) {
                // Get cropped image data as base64
                const croppedCanvas = cropper.getCroppedCanvas({
                    width: 400, // Desired output width
                    height: 400, // Desired output height (1:1 aspect ratio)
                });
                const croppedImageDataURL = croppedCanvas.toDataURL('image/png');

                // Apply to the correct preview element
                const previewElement = document.getElementById(currentImagePreviewId);
                const uploadArea = currentImageUploadAreaId ? document.getElementById(currentImageUploadAreaId) : null;

                if (previewElement) {
                    previewElement.src = croppedImageDataURL;
                    if (uploadArea) {
                        uploadArea.classList.add('has-image');
                    }
                    updatePreview();
                }
            }
            hideImageCropModal();
        }

        window.cancelImageCrop = function() {
            hideImageCropModal();
            // Optionally reset the input file field if the user cancels
            // This might be tricky if they want to re-select the same file after cancelling.
            // For now, we just close the modal.
        }


        // Initialize Firebase and authenticate
        window.onload = async function() {
            // Get Firebase config and app ID from the environment
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

            // En un entorno de GitHub Pages, esta configuración no existe.
            if (Object.keys(firebaseConfig).length === 0) {
                 console.warn("Firebase config is missing. Assuming a non-Canvas environment. Save functionality will not work.");
                 // Establecer un ID de usuario anónimo para que otras funciones no rompan.
                 userId = 'github-user';
                 // Añadir producto inicial y actualizar vista previa
                 addProduct();
                 updatePreview();
            } else {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Sign in using custom token or anonymously
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            userId = user.uid;
                            isAuthReady = true;
                            console.log("Usuario autenticado:", userId);
                            // Add initial product field and update preview
                            addProduct();
                            updatePreview();
                        } else {
                            console.log("No hay usuario autenticado.");
                            showMessageBox("No se pudo autenticar al usuario. Algunas funciones pueden no estar disponibles.");
                        }
                    });
                } catch (error) {
                    console.error("Error de autenticación de Firebase:", error);
                    showMessageBox(`Error de autenticación: ${error.message}. La función de guardar no estará disponible.`);
                }
            }


            // Event listeners for buttons
            document.getElementById('saveCatalogBtn').addEventListener('click', saveCatalog);
            document.getElementById('generatePdfBtn').addEventListener('click', generatePDF);
            document.getElementById('generateImageBtn').addEventListener('click', generateImage);
            // Initial call to check logo presence for '+' icon
            const logoPreview = document.getElementById('logoPreview');
            const logoUploadArea = document.getElementById('logoUploadArea');
            if (logoPreview.src && !logoPreview.src.includes('placehold.co')) {
                logoUploadArea.classList.add('has-image');
            } else {
                logoUploadArea.classList.remove('has-image');
            }
        };

        // Function to handle image uploads and display previews
        window.handleImageUpload = async function(event, previewId, uploadAreaId) { // Made async
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imgToCrop = document.getElementById('imageToCrop');
                    imgToCrop.src = e.target.result;
                    currentImagePreviewId = previewId;
                    currentImageUploadAreaId = uploadAreaId;
                    showImageCropModal();

                    setTimeout(() => {
                        if (cropper) {
                            cropper.destroy();
                        }
                        cropper = new Cropper(imgToCrop, {
                            aspectRatio: 1, // 1:1 aspect ratio for square logos/products
                            viewMode: 1, // Restrict the crop box to not exceed the canvas
                        });
                    }, 100);
                };
                reader.readAsDataURL(file);
            }
        };

        // Functions for generating content
        async function generateStoreSlogan() {
            // ... (implementación de la función)
            console.log("Generando eslogan...");
        }

        async function generatePhoneNumberQR() {
            const phoneNumber = document.getElementById('phoneNumber').value;
            if (!phoneNumber) {
                showMessageBox("Por favor, ingresa un número de teléfono.");
                return;
            }
            // Elimina caracteres no numéricos excepto el '+'
            const cleanedNumber = phoneNumber.replace(/[^0-9+]/g, '');
            const whatsappUrl = `https://wa.me/${cleanedNumber}`;
            
            const qrCodeContainer = document.getElementById('qrCodeContainer');
            qrCodeContainer.innerHTML = ''; // Limpiar cualquier QR anterior
            
            new QRious({
                element: qrCodeContainer,
                value: whatsappUrl,
                size: 200,
                padding: 10
            });
            showQrCodeModal();
        }
        
        async function generateAILogo() {
            const logoDescription = document.getElementById('logoDescription').value;
            const storeName = document.getElementById('storeName').value;
            if (!logoDescription) {
                showMessageBox("Por favor, describe el logo que deseas.");
                return;
            }
            
            const fullPrompt = `${logoDescription}. Para una tienda llamada ${storeName}. El logo debe ser minimalista y moderno, sin texto.`;
            
            hideGenerateLogoModal();
            showLoadingSpinner();
            
            try {
                const response = await fetch(`${BACKEND_URL}/generate-image`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: fullPrompt }),
                });

                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }

                const result = await response.json();
                const base64Image = result?.predictions?.[0]?.bytesBase64Encoded;

                if (base64Image) {
                    const logoPreview = document.getElementById('logoPreview');
                    const imageUrl = `data:image/png;base64,${base64Image}`;
                    logoPreview.src = imageUrl;
                    document.getElementById('logoUploadArea').classList.add('has-image');
                    updatePreview();
                    showMessageBox('¡Logo generado con éxito!');
                } else {
                    throw new Error('No se pudo generar la imagen o la respuesta no es válida.');
                }

            } catch (error) {
                console.error('Error al generar logo con IA:', error);
                showMessageBox(`Error al generar el logo: ${error.message}.`);
            } finally {
                hideLoadingSpinner();
            }
        }
        
        async function summarizeCatalog() {
             // ... (implementación de la función)
             console.log("Resumiendo catálogo...");
        }

        async function updatePreview() {
            // ... (implementación de la función)
            console.log("Actualizando vista previa...");
        }

        async function addProduct() {
             // ... (implementación de la función)
             console.log("Añadiendo producto...");
        }

        async function saveCatalog() {
            // ... (implementación de la función)
            console.log("Guardando catálogo...");
        }
        
        async function generatePDF() {
            // ... (implementación de la función)
            console.log("Generando PDF...");
        }

        async function generateImage() {
            // ... (implementación de la función)
            console.log("Generando imagen del catálogo...");
        }
        
        function showLoadingSpinner() {
            document.getElementById('loading-spinner').classList.remove('hidden');
        }

        function hideLoadingSpinner() {
            document.getElementById('loading-spinner').classList.add('hidden');
        }

    </script>
</body>
</html>
