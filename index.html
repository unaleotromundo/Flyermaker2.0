<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Editor Canvas Pro v2.0</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&family=Bebas+Neue&family=Anton&family=Lobster&family=Oswald&family=Poppins&family=Playfair+Display:wght@700&family=Permanent+Marker&family=Rock+Salt&family=Luckiest+Guy&family=Shadows+Into+Light&family=Orbitron:wght@900&family=Archivo+Black&family=Quicksand:wght@700&family=Arizonia&family=Bangers&family=Covered+By+Your+Grace&family=Fredericka+the+Great&family=Indie+Flower&family=Pacifico&family=Press+Start+2P&family=Gloria+Hallelujah&family=Rammetto+One&family=Monoton&family=Rubik+Moonrocks&family=Special+Elite&family=Amatic+SC:wght@700&family=VT323&family=Chewy&family=Black+Ops+One&family=Faster+One&family=Acme&family=Rye&family=Rubik+80s+Fade&family=Sigmar+One&family=UnifrakturCook&family=Sacramento&family=Chango&family=Major+Mono+Display&family=IBM+Plex+Mono:wght@700&family=Poiret+One&family=Unbounded:wght@700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
:root {
  --c-cyan: #00B4D8;
  --c-magenta: #D0006F;
  --c-yellow: #FFD166;
  --c-key: #073B4C;
  --surface: rgba(255, 255, 255, 0.92);
  --border: rgba(0, 0, 0, 0.08);
  --text: #0f172a;
  --text-secondary: #64748b;
  --shadow: 0 4px 24px rgba(0,0,0,0.05);
  --shadow-active: 0 6px 32px rgba(0,0,0,0.12);
  --panel-bg: rgba(255, 255, 255, 0.85);
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Montserrat', sans-serif;
  background: linear-gradient(135deg, #fbfcfd 0%, #f6f9fb 100%);
  min-height: 100vh;
  color: var(--text);
  overflow: hidden;
  touch-action: none;
}

header {
  display: flex;
  overflow-x: auto;
  gap: 6px;
  padding: 8px;
  background: var(--panel-bg);
  backdrop-filter: blur(12px);
  box-shadow: var(--shadow);
  z-index: 100;
  scrollbar-width: none;
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
}

header::-webkit-scrollbar {
  display: none;
}

.icon-btn {
  flex: 0 0 auto;
  width: 54px;
  height: 54px;
  border-radius: 12px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  background: linear-gradient(145deg, #ffffff, #f0f0f0);
  box-shadow: 
    0 4px 8px rgba(0,0,0,0.1),
    inset 0 -2px 0 rgba(0,0,0,0.05),
    inset 0 0 10px rgba(255,255,255,0.5);
  cursor: pointer;
  border: 1px solid transparent; /* Borde para el estado activo */
  transition: all 0.2s ease;
  position: relative;
  overflow: hidden;
}

.icon-btn.active {
    border-color: var(--c-cyan);
    box-shadow: 0 0 0 2px var(--c-cyan), inset 0 2px 4px rgba(0,0,0,0.1);
}

#zoomModeBtn svg path {
    fill: #333;
    stroke: #333;
}
body.dark #zoomModeBtn svg path {
    fill: #f1f5f9;
    stroke: #f1f5f9;
}

/* Colores de fondo CMYK */
#bgColorBtn { background: var(--c-cyan); }
#addTextBtn { background: var(--c-magenta); }
#addImageBtn { background: var(--c-yellow); }
#generateQrBtn { background: var(--c-key); }
#exportBtn { background: #E9ECEF; }
#clearCanvasBtn { background: #3db52d; }

.icon-btn::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 100%;
  background: linear-gradient(rgba(255,255,255,0.2), transparent);
  pointer-events: none;
}

.icon-btn:hover {
  transform: translateY(-3px);
  box-shadow: 
    0 6px 12px rgba(0,0,0,0.15),
    inset 0 -2px 0 rgba(0,0,0,0.05),
    inset 0 0 10px rgba(255,255,255,0.5);
}

.icon-btn:active {
  transform: translateY(1px);
  box-shadow: 
    0 2px 4px rgba(0,0,0,0.1),
    inset 0 -2px 0 rgba(0,0,0,0.05),
    inset 0 0 10px rgba(255,255,255,0.5);
}

.icon-btn svg {
  width: 24px;
  height: 24px;
  filter: drop-shadow(0 2px 2px rgba(0,0,0,0.1));
}

.icon-btn svg path, .icon-btn svg rect, .icon-btn svg circle {
  fill: #fff;
  stroke: #fff;
}

#exportBtn .icon-label, #clearCanvasBtn .icon-label {
    color: var(--text);
    text-shadow: none;
}

.icon-label {
  font-size: 9px;
  font-weight: 600;
  margin-top: 4px;
  text-align: center;
  color: #fff;
  text-shadow: 0 1px 1px rgba(0,0,0,0.3);
}

main {
  position: fixed;
  top: 70px;
  left: 0;
  right: 0;
  bottom: 38px;
  display: flex;
  justify-content: center;
  align-items: center;
  background: #f0f4f8;
}

.canvas-container {
  position: relative;
  width: 100%;
  height: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
  overflow: hidden;
}

#flyerCanvas {
  background: #fff;
  border: 1px solid #e2e8f0;
  box-shadow: 0 4px 12px rgba(0,0,0,0.05);
  max-width: 100%;
  max-height: 100%;
  touch-action: none;
}

.floating-tools {
  position: absolute;
  top: 20px;
  right: 20px;
  background: var(--panel-bg);
  backdrop-filter: blur(8px);
  border-radius: 12px;
  box-shadow: var(--shadow);
  display: flex;
  flex-direction: column; 
  gap: 6px;
  padding: 8px;
  border: 1px solid var(--border);
  z-index: 10;
  cursor: move;
  user-select: none;
  flex-wrap: wrap; 
}

.floating-tools button {
  width: 36px;
  height: 36px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #fff;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
  cursor: pointer;
  border: none;
  font-size: 16px;
  transition: all 0.2s ease;
}

.floating-tools button:hover {
  background: #f1f5f9;
}

#generalTools, #textTools, #imageTools {
  display: flex;
  gap: 6px;
  background: #fff;
  padding: 6px;
  border-radius: 10px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}

.popup {
  display: none;
  position: fixed;
  left: 0; top: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.7);
  z-index: 200;
  align-items: center;
  justify-content: center;
  padding: 16px;
}

.popup-content {
  background: var(--panel-bg);
  padding: 24px;
  border-radius: 16px;
  max-width: 600px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 20px 50px rgba(0,0,0,0.3);
  backdrop-filter: blur(20px);
  border: 1px solid var(--border);
  display: flex;
  flex-direction: column;
}

.popup-title {
  font-size: 20px;
  font-weight: 600;
  margin-bottom: 20px;
  color: var(--text);
  text-align: center;
  position: relative;
  padding-bottom: 12px;
}

.popup-title::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 60px;
  height: 3px;
  background: linear-gradient(90deg, var(--c-cyan), var(--c-magenta));
  border-radius: 3px;
}

.image-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
  gap: 12px;
  margin-bottom: 20px;
  flex-grow: 1;
  min-height: 200px;
}

.image-thumb {
  width: 100%;
  height: 100px;
  object-fit: cover;
  border-radius: 10px;
  border: 2px solid var(--border);
  cursor: pointer;
  transition: all 0.2s ease;
  background-color: #e2e8f0;
}

.image-thumb:hover {
  transform: scale(1.05);
  box-shadow: 0 6px 16px rgba(0,0,0,0.1);
}

.popup-close {
  width: 100%;
  padding: 14px;
  background: var(--c-key);
  color: white;
  border: none;
  border-radius: 12px;
  font-weight: 600;
  font-size: 16px;
  cursor: pointer;
  transition: background 0.2s;
  margin-top: 10px;
}

.popup-close:hover {
  background: #052a39;
}

.font-selector {
  max-height: 300px;
  overflow-y: auto;
  border: 1px solid var(--border);
  border-radius: 10px;
  background: #fff;
  padding: 8px;
  display: grid;
  gap: 8px;
  margin-bottom: 16px;
}

.font-option {
  padding: 12px;
  border-radius: 8px;
  background: #f8fafc;
  cursor: pointer;
  font-size: 16px;
  border: 1px solid transparent;
  transition: all 0.15s ease;
  text-align: center;
  font-weight: 500;
}

.font-option:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.06);
}

.font-option.selected {
  background: var(--c-cyan);
  color: #fff;
  border-color: rgba(0,0,0,0.06);
  box-shadow: 0 4px 12px rgba(0, 180, 216, 0.3);
}

footer {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: var(--panel-bg);
  backdrop-filter: blur(12px);
  padding: 8px 20px;
  font-size: 12px;
  color: var(--text-secondary);
  border-top: 1px solid var(--border);
  z-index: 90;
  display: flex;
  justify-content: space-between;
  align-items: center;
  height: 38px;
}

.footer-links { display: flex; gap: 12px; }
.footer-links a { color: var(--text); text-decoration: none; transition: color 0.2s; font-weight: 500; font-size: 12px; }
.footer-links a:hover { color: var(--c-cyan); }

.help-message {
  position: absolute;
  bottom: 50px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0, 0, 0, 0.7);
  color: white;
  padding: 8px 16px;
  border-radius: 20px;
  font-size: 14px;
  z-index: 10;
  animation: fadeInOut 4s forwards;
  display: none;
}

@keyframes fadeInOut {
  0% { opacity: 0; }
  10% { opacity: 1; }
  90% { opacity: 1; }
  100% { opacity: 0; display: none; }
}

@media (max-width: 768px) {
  .icon-btn { width: 48px; height: 48px; }
  .popup-content { padding: 16px; }
  .font-selector { max-height: 200px; }
  .floating-tools { top: 10px; right: 10px; transform: scale(0.9); }
  .icon-label { font-size: 8px; }
  footer { flex-direction: column; gap: 4px; padding: 6px; height: auto; }
}

@media (max-width: 480px) {
  .icon-btn { width: 44px; height: 44px; }
  header { padding: 6px; gap: 4px; }
  .popup-title { font-size: 18px; }
  footer { flex-direction: column; gap: 4px; padding: 6px; }
  .footer-links { gap: 8px; }
  .icon-label { font-size: 7px; }
}

.hidden-input { display: none; }

.upload-card {
  width: 100%;
  height: 100px;
  background-color: #f0f4f8;
  border: 2px dashed #94a3b8;
  border-radius: 10px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  color: #64748b;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.2s ease;
  margin-bottom: 20px;
}

.upload-card:hover {
  background-color: #e2e8f0;
  border-color: #334155;
  color: #334155;
}

.search-wrapper {
    display: flex;
    gap: 8px;
    margin-bottom: 20px;
}

#imageSearchInput {
    flex-grow: 1;
    padding: 12px;
    border-radius: 10px;
    border: 1px solid var(--border);
    font-size: 16px;
    background: #999393;
}

#imageSearchBtn {
    padding: 0 20px;
    background: var(--c-cyan);
    color: white;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    transition: background .2s;
}
#imageSearchBtn:hover {
    background: #0096b2;
}

body.dark {
  --surface: rgba(15, 23, 42, 0.92);
  --border: rgba(255, 255, 255, 0.1);
  --text: #f1f5f9;
  --text-secondary: #94a3b8;
  --shadow: 0 4px 24px rgba(0,0,0,0.2);
  --shadow-active: 0 6px 32px rgba(0,0,0,0.3);
  --panel-bg: rgba(15, 23, 42, 0.85);
  background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
}

body.dark .icon-btn {
  background: linear-gradient(145deg, #1e293b, #0f172a);
  box-shadow: 0 4px 8px rgba(0,0,0,0.3), inset 0 -2px 0 rgba(0,0,0,0.1), inset 0 0 10px rgba(255,255,255,0.1);
}

body.dark .icon-btn svg path, body.dark .icon-btn svg rect, body.dark .icon-btn svg circle {
  fill: #f1f5f9;
  stroke: #f1f5f9;
}

body.dark .icon-label, body.dark #exportBtn .icon-label, body.dark , body.dark #clearCanvasBtn .icon-label {
  color: #f1f5f9;
}

body.dark .canvas-container { background: #1e293b; }
body.dark #flyerCanvas { border: 1px solid #334155; }
body.dark .popup-content, body.dark .font-selector, body.dark .font-option { background: #1e293b; color: #f1f5f9; border-color: var(--border); }
body.dark .upload-card { background: #334155; border-color: #475569; color: #cbd5e1; }
body.dark .search-wrapper input { background: #334155; color: #f1f5f9; border-color: var(--border); }

#themeToggleBtn {
  background: linear-gradient(145deg, #0f172a, #1e293b);
  box-shadow: 0 4px 8px rgba(0,0,0,0.3), inset 0 -2px 0 rgba(0,0,0,0.1), inset 0 0 10px rgba(255,255,255,0.1);
}
#themeToggleBtn svg path {
  fill: #f1f5f9;
  stroke: #f1f5f9;
}
#themeToggleBtn .icon-label {
  color: #f1f5f9;
}

body.dark #themeToggleBtn {
  background: linear-gradient(145deg, #ffffff, #f0f0f0);
  box-shadow: 0 4px 8px rgba(0,0,0,0.1), inset 0 -2px 0 rgba(0,0,0,0.05), inset 0 0 10px rgba(255,255,255,0.5);
}
body.dark #themeToggleBtn svg path {
  fill: #0f172a;
  stroke: #0f172a;
}
body.dark #themeToggleBtn .icon-label {
  color: #0f172a;
}
#exportBtn svg path {
  fill: #000000;
  stroke: #000000;
}
#exportBtn .icon-label {
  color: #000000;
}
body.dark #exportBtn svg path {
  fill: #000000;
  stroke: #000000;
}
body.dark #exportBtn .icon-label {
  color: #000000;
}

#resetViewBtn {
    position: absolute;
    bottom: 20px;
    right: 20px;
    z-index: 101;
    background: var(--panel-bg);
    backdrop-filter: blur(8px);
    border-radius: 20px;
    box-shadow: var(--shadow-active);
    border: 1px solid var(--border);
    padding: 8px 16px;
    font-size: 14px;
    font-weight: 600;
    color: var(--text);
    cursor: pointer;
    display: none; /* Oculto por defecto */
    transition: opacity 0.3s, transform 0.3s;
}
#resetViewBtn:hover {
    transform: scale(1.05);
}

</style>
</head>
<body>
<header>
  <button class="icon-btn" title="Zoom" id="zoomModeBtn">
      <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
      <span class="icon-label">Zoom</span>
  </button>

  <button class="icon-btn" title="Color de fondo" id="bgColorBtn">
    <svg viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"></path></svg>
    <span class="icon-label">Fondo</span>
  </button>
  
  <button class="icon-btn" title="Agregar texto" id="addTextBtn">
    <svg viewBox="0 0 24 24"><path d="M2.5 4v3h5v12h3V7h5V4h-13zm19 5h-9v3h3v7h3v-7h3V9z"></path></svg>
    <span class="icon-label">Texto</span>
  </button>
  
  <button class="icon-btn" title="Agregar imagen" id="addImageBtn">
    <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zM12 5c-3.86 0-7 3.14-7 7s3.14 7 7 7V5z"></path></svg>
    <span class="icon-label">Imagen</span>
  </button>
  
  <button class="icon-btn" title="Generar QR" id="generateQrBtn">
    <svg viewBox="0 0 24 24"><path d="M3 11h8V3H3v8zm2-6h4v4H5V5zM3 21h8v-8H3v8zm2-6h4v4H5v-4zm8-12v8h8V3h-8zm6 6h-4V5h4v4zm-6 8h8v-8h-8v8zm2-6h4v4h-4v-4z"></path></svg>
    <span class="icon-label">QR</span>
  </button>
  
  <button class="icon-btn" title="Exportar" id="exportBtn">
    <svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"></path></svg>
    <span class="icon-label">Exportar</span>
  </button>
  
  <button class="icon-btn" title="Limpiar todo" id="clearCanvasBtn">
    <svg viewBox="0 0 24 24"><path d="M19 4h-3.5l-1-1h-5l-1 1H5v2h14V4zM6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12z"></path></svg>
    <span class="icon-label">Limpiar</span>
  </button>
  
  <button class="icon-btn" title="Cambiar tema" id="themeToggleBtn">
    <svg id="themeIcon" viewBox="0 0 24 24"></svg>
    <span class="icon-label">Tema</span>
  </button>
</header>

<main>
  <div class="canvas-container">
    <canvas id="flyerCanvas" width="800" height="1066"></canvas>
    <div class="floating-tools" id="floatingTools" style="display:none;">
      <div id="generalTools">
          <button id="btnSubirCapa" title="Subir capa">↑</button>
          <button id="btnBajarCapa" title="Bajar capa">↓</button>
          <button id="btnEnviarFondo" title="Enviar al fondo">⤓</button>
          <button id="btnEliminar" title="Eliminar">🗑</button>
      </div>
      <div id="textTools" style="display: none;">
          <button id="btnOpenFontPopup" title="Cambiar fuente">Aa</button>
          <button id="btnOpenTextColorPopup" title="Cambiar color">🎨</button>
          <button id="btnAlinIzq" title="Alinear izquierda">⚍</button>
          <button id="btnAlinCen" title="Alinear centro">☰</button>
          <button id="btnAlinDer" title="Alinear derecha">⚍</button>
      </div>
      <div id="imageTools" style="display: none;">
          <button id="btnApplyFilter" title="Aplicar filtro">✨</button>
          <button id="btnRemoveFilters" title="Quitar filtros">🚫</button>
      </div>
    </div>
    <div class="help-message" id="helpMessage">¡Puedes mover, rotar y escalar los objetos!</div>
    
    <button id="resetViewBtn">Restaurar Vista</button>

  </div>
</main>

<div class="popup" id="imgGalleryPopup">
  <div class="popup-content">
    <div class="popup-title">Galería de Imágenes</div>
    <div class="search-wrapper">
        <input type="text" id="imageSearchInput" placeholder="Busca por palabra (ej: 'fiesta', 'comidas', 'tecnologia')">
        <button id="imageSearchBtn">Buscar</button>
    </div>
    <label for="bgLocalInput" class="upload-card">
      <span>⬆️</span>
      Subir tu propia imagen
    </label>
    <input type="file" id="bgLocalInput" accept="image/*" class="hidden-input">
    <div class="image-grid" id="imgFondoGrid"></div>
    <button class="popup-close">Cerrar</button>
  </div>
</div>

<div class="popup" id="fontPopup">
  <div class="popup-content">
    <div class="popup-title">Seleccionar fuente</div>
    <div id="customFontSelector" class="font-selector"></div>
    <button class="popup-close">Aplicar</button>
  </div>
</div>

<div class="popup" id="exportPopup">
  <div class="popup-content">
    <div class="popup-title">Exportar Flyer</div>
    <button class="popup-close" id="btnDescargarJPG">Descargar como JPG</button>
    <button class="popup-close" id="btnDescargarPDF" style="margin-top: 10px;">Descargar como PDF</button>
  </div>
</div>

<footer>
  <div>Hecho con 💜 por OtroMundo</div>
  <div class="footer-links">
    <a href="https://unaleotromundo.github.io/otromundo/" target="_blank">GitHub</a>
    <a href="https://wa.me/59894691690?text=Hola%20%F0%9F%91%8B%20Quisiera%20informaci%C3%B3n">Contacto</a>
  </div>
</footer>

<script>
// --- CONFIGURACIÓN ---
const UNSPLASH_ACCESS_KEY = 'Xj3SNeQvEW2iW-s3L0vLZgBGrve7ZUFVUGPF_hXLjFI'; 

const fontFamilies = {
  "Montserrat": "'Montserrat', Arial, sans-serif", "Bebas Neue": "'Bebas Neue', Arial, sans-serif", "Anton": "'Anton', Arial, sans-serif", "Archivo Black": "'Archivo Black', Arial, sans-serif", "Oswald": "'Oswald', Arial, sans-serif", "Poppins": "'Poppins', Arial, sans-serif", "Lobster": "'Lobster', cursive", "Playfair Display": "'Playfair Display', serif", "Permanent Marker": "'Permanent Marker', cursive", "Rock Salt": "'Rock Salt', cursive", "Luckiest Guy": "'Luckiest Guy', cursive", "Shadows Into Light": "'Shadows Into Light', cursive", "Orbitron": "'Orbitron', sans-serif", "Quicksand": "'Quicksand', Arial, sans-serif", "Arizonia": "'Arizonia', cursive", "Bangers": "'Bangers', cursive", "Covered By Your Grace": "'Covered By Your Grace', cursive", "Fredericka the Great": "'Fredericka the Great', cursive", "Indie Flower": "'Indie Flower', cursive", "Pacifico": "'Pacifico', cursive", "Press Start 2P": "'Press Start 2P', monospace", "Gloria Hallelujah": "'Gloria Hallelujah', cursive", "Rammetto One": "'Rammetto One', cursive", "Monoton": "'Monoton', cursive", "Rubik Moonrocks": "'Rubik Moonrocks', cursive", "Special Elite": "'Special Elite', monospace", "Amatic SC": "'Amatic SC', cursive", "VT323": "'VT323', monospace", "Chewy": "'Chewy', cursive", "Black Ops One": "'Black Ops One', cursive", "Faster One": "'Faster One', cursive", "Acme": "'Acme', sans-serif", "Rye": "'Rye', cursive", "Rubik 80s Fade": "'Rubik 80s Fade', cursive", "Sigmar One": "'Sigmar One', cursive", "UnifrakturCook": "'UnifrakturCook', cursive", "Sacramento": "'Sacramento', cursive", "Chango": "'Chango', cursive", "Major Mono Display": "'Major Mono Display', monospace", "IBM Plex Mono": "'IBM Plex Mono', monospace", "Poiret One": "'Poiret One', cursive", "Unbounded": "'Unbounded', sans-serif"
};

const canvas = new fabric.Canvas('flyerCanvas', { 
    preserveObjectStacking: true, selection: true, allowTouchScrolling: true, enableRetinaScaling: true, devicePixelRatio: window.devicePixelRatio || 1, selectionColor: 'rgba(0, 180, 216, 0.3)', selectionBorderColor: 'rgba(0, 180, 216, 0.8)', selectionLineWidth: 2, hoverCursor: 'move', defaultCursor: 'default'
});
canvas.setBackgroundColor('#ffffff', canvas.renderAll.bind(canvas));
fabric.Textbox.prototype.textBaseline = 'alphabetic';

// --- FUNCIONES BÁSICAS ---

function saveCanvasState() {
  try {
    const json = canvas.toJSON();
    localStorage.setItem('savedCanvas', JSON.stringify(json));
    showHelpMessage("Progreso guardado automáticamente.", 1500);
  } catch (error) { console.error('No se pudo guardar el estado del canvas:', error); }
}

function loadCanvasState() {
  const savedState = localStorage.getItem('savedCanvas');
  if (savedState) {
    canvas.loadFromJSON(savedState, canvas.renderAll.bind(canvas));
    showHelpMessage("¡Bienvenido de vuelta! Se cargó tu último diseño.", 3000);
  }
}

async function searchUnsplashImages(query) {
  if (!UNSPLASH_ACCESS_KEY || UNSPLASH_ACCESS_KEY === 'TU_CLAVE_DE_API_DE_UNSPLASH') {
    alert('Por favor, configura tu clave de API de Unsplash en el script.');
    return;
  }
  const imgGrid = document.getElementById('imgFondoGrid');
  imgGrid.innerHTML = '<p>Buscando imágenes...</p>';
  try {
    const response = await fetch(`https://api.unsplash.com/search/photos?query=${encodeURIComponent(query)}&per_page=12&client_id=${UNSPLASH_ACCESS_KEY}`);
    if (!response.ok) throw new Error(`Error de Unsplash: ${response.statusText}`);
    const data = await response.json();
    imgGrid.innerHTML = '';
    if (data.results.length === 0) {
      imgGrid.innerHTML = '<p>No se encontraron resultados. Intenta otra búsqueda.</p>';
      return;
    }
    data.results.forEach(photo => {
      const img = document.createElement("img");
      img.src = photo.urls.small;
      img.className = "image-thumb";
      img.alt = photo.alt_description;
      img.addEventListener("click", () => addImageToCanvas(photo.urls.regular));
      imgGrid.appendChild(img);
    });
  } catch(error) {
    console.error("Error al buscar imágenes:", error);
    imgGrid.innerHTML = `<p>Error al cargar imágenes. Revisa la consola.</p>`;
  }
}

async function loadAndApplyFont(fontName, fontFamily) {
  if (document.fonts.check(`1em "${fontName}"`)) {
    applyFont(fontFamily, fontName);
    return;
  }
  showHelpMessage(`Cargando fuente: ${fontName}...`, 1500);
  const link = document.createElement('link');
  const formattedFontName = fontName.replace(/ /g, '+');
  link.href = `https://fonts.googleapis.com/css2?family=${formattedFontName}:wght@400;700&display=swap`;
  link.rel = 'stylesheet';
  document.head.appendChild(link);
  link.onload = () => applyFont(fontFamily);
}

function applyFont(fontFamily) {
  const active = canvas.getActiveObject();
  if (active && active.type === "textbox") {
    active.set("fontFamily", fontFamily);
    canvas.renderAll();
  }
}

function addImageToCanvas(url) {
  fabric.Image.fromURL(url, (img) => {
    const scale = Math.min((canvas.width * 0.6) / img.width, (canvas.height * 0.6) / img.height);
    img.scale(scale).set({ left: canvas.width / 2, top: canvas.height / 2, originX: "center", originY: "center", hasControls: true, crossOrigin: 'anonymous' });
    canvas.add(img).setActiveObject(img).renderAll();
    showHelpMessage("Imagen agregada. Puedes moverla, rotarla y escalarla.", 3000);
    document.getElementById('imgGalleryPopup').style.display = 'none';
  }, { crossOrigin: 'anonymous' });
}

function adjustCanvasSize() {
  const container = document.querySelector('.canvas-container');
  const aspectRatio = 800 / 1066;
  let newWidth = container.clientWidth * 0.95;
  let newHeight = newWidth / aspectRatio;
  
  if (newHeight > container.clientHeight * 0.95) {
    newHeight = container.clientHeight * 0.95;
    newWidth = newHeight * aspectRatio;
  }
  
  canvas.setWidth(newWidth).setHeight(newHeight).renderAll();
}

function showHelpMessage(message, duration = 4000) {
  const helpElement = document.getElementById('helpMessage');
  helpElement.textContent = message;
  helpElement.style.display = 'block';
  helpElement.style.animation = 'none';
  void helpElement.offsetWidth;
  helpElement.style.animation = `fadeInOut ${duration / 1000}s forwards`;
}

function renderFontOptions() {
  const container = document.getElementById("customFontSelector");
  if (container.children.length > 0) return;
  
  Object.keys(fontFamilies).forEach(fontName => {
    const div = document.createElement("div");
    div.className = "font-option";
    div.textContent = fontName;
    div.style.fontFamily = fontFamilies[fontName] || fontName;
    div.addEventListener("click", () => {
      document.querySelectorAll('.font-option').forEach(o => o.classList.remove('selected'));
      div.classList.add('selected');
      loadAndApplyFont(fontName, fontFamilies[fontName] || fontName);
    });
    container.appendChild(div);
  });
}

// --- EVENT LISTENERS GENERALES ---
window.addEventListener('load', () => {
  adjustCanvasSize();
  loadCanvasState();
  enterSelectMode();
});
window.addEventListener('resize', adjustCanvasSize);

canvas.on({ 'object:modified': saveCanvasState, 'object:added': saveCanvasState, 'object:removed': saveCanvasState });

document.getElementById('addImageBtn').addEventListener('click', () => {
  document.getElementById('imgGalleryPopup').style.display = 'flex';
  if (document.getElementById('imgFondoGrid').innerHTML === '') searchUnsplashImages('abstract background');
});

document.getElementById('bgLocalInput').addEventListener('change', function(e) {
  if (!e.target.files || !e.target.files[0]) return;
  const reader = new FileReader();
  reader.onload = (event) => addImageToCanvas(event.target.result);
  reader.readAsDataURL(e.target.files[0]);
  e.target.value = "";
});

document.getElementById('bgColorBtn').addEventListener('click', () => {
  const picker = document.createElement('input');
  picker.type = 'color';
  picker.value = canvas.backgroundColor;
  picker.oninput = () => canvas.setBackgroundColor(picker.value, canvas.renderAll.bind(canvas));
  picker.onchange = saveCanvasState;
  picker.click();
});

document.getElementById('addTextBtn').addEventListener('click', () => {
  const textObj = new fabric.Textbox("Tu texto aquí", { left: canvas.width / 2, top: canvas.height / 2, fontSize: 40, fill: '#333', fontFamily: fontFamilies["Montserrat"], originX: "center", originY: "center", editable: true, width: canvas.width * 0.8, textAlign: 'center' });
  canvas.add(textObj).setActiveObject(textObj).renderAll();
});

document.getElementById('generateQrBtn').addEventListener('click', () => {
  const tel = prompt("Ingresa número de WhatsApp (ej: 094123456):", "");
  if (tel && tel.match(/^\d{6,}$/)) {
    const url = `https://wa.me/598${tel}?text=¡Hola!%20Vi%20tu%20flyer%20y%20me%20interesa%20saber%20más`;
    const qr = new QRious({ value: url, size: 300 });
    addImageToCanvas(qr.toDataURL());
  } else {
    alert("Por favor, ingresa un número de WhatsApp válido.");
  }
});

document.getElementById('clearCanvasBtn').addEventListener('click', () => {
    if(confirm('¿Estás seguro de que quieres borrar todo el diseño? Esta acción no se puede deshacer.')) {
        canvas.clear();
        canvas.setBackgroundColor('#ffffff', canvas.renderAll.bind(canvas));
        localStorage.removeItem('savedCanvas');
        resetCanvasView();
    }
});

document.getElementById('exportBtn').addEventListener('click', () => document.getElementById('exportPopup').style.display = 'flex');
document.querySelectorAll('.popup-close').forEach(btn => btn.addEventListener('click', () => btn.closest('.popup').style.display = 'none'));
document.getElementById('btnDescargarJPG').addEventListener('click', () => {
  const url = canvas.toDataURL({ format: "jpeg", quality: 0.95, multiplier: 2 });
  const link = document.createElement("a");
  link.href = url;
  link.download = "flyer.jpg";
  link.click();
});
document.getElementById('btnDescargarPDF').addEventListener('click', () => {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({ orientation: "portrait", unit: "px", format: [canvas.width, canvas.height] });
  pdf.addImage(canvas.toDataURL({ format: "jpeg", quality: 1.0, multiplier: 2 }), "JPEG", 0, 0, canvas.width, canvas.height);
  pdf.save("flyer.pdf");
});

const floatingTools = document.getElementById('floatingTools');
const textTools = document.getElementById('textTools');
const imageTools = document.getElementById('imageTools');
const updateTools = (e) => {
    const target = e?.selected?.[0];
    floatingTools.style.display = target ? 'flex' : 'none';
    if (target) {
        textTools.style.display = target.type === 'textbox' ? 'flex' : 'none';
        imageTools.style.display = target.type === 'image' ? 'flex' : 'none';
    }
};
canvas.on({'selection:created': updateTools, 'selection:updated': updateTools, 'selection:cleared': updateTools});

document.getElementById('btnSubirCapa').addEventListener('click', () => canvas.getActiveObject() && canvas.bringForward(canvas.getActiveObject()));
document.getElementById('btnBajarCapa').addEventListener('click', () => canvas.getActiveObject() && canvas.sendBackwards(canvas.getActiveObject()));
document.getElementById('btnEnviarFondo').addEventListener('click', () => canvas.getActiveObject() && canvas.sendToBack(canvas.getActiveObject()));
document.getElementById('btnEliminar').addEventListener('click', () => canvas.getActiveObject() && canvas.remove(canvas.getActiveObject()));
document.getElementById('btnAlinIzq').addEventListener('click', () => canvas.getActiveObject()?.set("textAlign", "left").setCoords() && canvas.renderAll());
document.getElementById('btnAlinCen').addEventListener('click', () => canvas.getActiveObject()?.set("textAlign", "center").setCoords() && canvas.renderAll());
document.getElementById('btnAlinDer').addEventListener('click', () => canvas.getActiveObject()?.set("textAlign", "right").setCoords() && canvas.renderAll());
document.getElementById('btnOpenFontPopup').addEventListener('click', () => {
  renderFontOptions();
  document.getElementById('fontPopup').style.display = 'flex';
});
document.getElementById('btnOpenTextColorPopup').addEventListener('click', () => {
  const active = canvas.getActiveObject();
  if (active?.type === 'textbox') {
    const picker = document.createElement('input');
    picker.type = 'color';
    picker.value = active.fill;
    picker.oninput = () => { active.set("fill", picker.value); canvas.renderAll(); };
    picker.onchange = saveCanvasState;
    picker.click();
  }
});

document.getElementById('imageSearchBtn').addEventListener('click', () => {
    const query = document.getElementById('imageSearchInput').value;
    if(query.trim()) searchUnsplashImages(query);
});
document.getElementById('imageSearchInput').addEventListener('keyup', (e) => {
    if (e.key === 'Enter') searchUnsplashImages(e.target.value);
});

const filters = [ new fabric.Image.filters.Grayscale(), new fabric.Image.filters.Sepia(), new fabric.Image.filters.Invert(), new fabric.Image.filters.Vintage(), new fabric.Image.filters.Kodachrome(), new fabric.Image.filters.Technicolor(), new fabric.Image.filters.Brownie(), new fabric.Image.filters.Polaroid(), new fabric.Image.filters.Brightness({ brightness: 0.2 }), new fabric.Image.filters.Contrast({ contrast: 0.2 }) ];
let currentFilterIndex = 0;
document.getElementById('btnApplyFilter').addEventListener('click', () => {
  const obj = canvas.getActiveObject();
  if (obj?.type === 'image') {
    currentFilterIndex = (currentFilterIndex + 1) % filters.length;
    obj.filters = [filters[currentFilterIndex]];
    obj.applyFilters();
    canvas.renderAll();
    showHelpMessage(`Filtro aplicado: ${filters[currentFilterIndex].type}`);
  }
});
document.getElementById('btnRemoveFilters').addEventListener('click', () => {
  const obj = canvas.getActiveObject();
  if (obj?.type === 'image') {
    obj.filters = [];
    obj.applyFilters();
    canvas.renderAll();
    currentFilterIndex = 0;
  }
});

function updateToggleIcon() {
  const icon = document.getElementById('themeIcon');
  if (document.body.classList.contains('dark')) {
    icon.innerHTML = '<path d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>';
  } else {
    icon.innerHTML = '<path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/>';
  }
}

function toggleTheme() {
  document.body.classList.toggle('dark');
  localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
  updateToggleIcon();
  canvas.renderAll();
}

const savedTheme = localStorage.getItem('theme');
if (savedTheme === 'dark') {
  document.body.classList.add('dark');
}
updateToggleIcon();

document.getElementById('themeToggleBtn').addEventListener('click', toggleTheme);


// --- INICIO: NUEVO SISTEMA DE ZOOM ---

let currentMode = 'select'; // 'select' o 'zoom'
let zoomRect = null;

const zoomModeBtn = document.getElementById('zoomModeBtn');
const resetViewBtn = document.getElementById('resetViewBtn');

function enterSelectMode() {
    currentMode = 'select';
    canvas.selection = true;
    canvas.defaultCursor = 'default';
    canvas.hoverCursor = 'move';
    canvas.getObjects().forEach(obj => obj.selectable = true);
    zoomModeBtn.classList.remove('active');
    canvas.renderAll();
}

function enterZoomMode() {
    currentMode = 'zoom';
    canvas.selection = false;
    canvas.defaultCursor = 'crosshair';
    canvas.hoverCursor = 'crosshair';
    canvas.getObjects().forEach(obj => obj.selectable = false);
    zoomModeBtn.classList.add('active');
    canvas.discardActiveObject().renderAll();
}

function resetCanvasView() {
    canvas.setViewportTransform([1, 0, 0, 1, 0, 0]); // Matriz de transformación identidad
    resetViewBtn.style.display = 'none'; // Ocultar el botón al restaurar
    canvas.renderAll();
}

zoomModeBtn.addEventListener('click', () => {
    if (currentMode === 'zoom') {
        enterSelectMode();
    } else {
        enterZoomMode();
    }
});
resetViewBtn.addEventListener('click', resetCanvasView);


canvas.on('mouse:down', function(opt) {
    const evt = opt.e;
    if (currentMode === 'zoom') {
        const pointer = canvas.getPointer(evt);
        zoomRect = new fabric.Rect({
            left: pointer.x,
            top: pointer.y,
            width: 0,
            height: 0,
            fill: 'rgba(0, 180, 216, 0.2)',
            stroke: 'rgba(0, 180, 216, 1)',
            strokeWidth: 1,
            selectable: false,
            evented: false,
        });
        canvas.add(zoomRect);
    }
});

canvas.on('mouse:move', function(opt) {
    if (currentMode === 'zoom' && zoomRect) {
        const pointer = canvas.getPointer(opt.e);
        const startX = zoomRect.left;
        const startY = zoomRect.top;
        let width = pointer.x - startX;
        let height = pointer.y - startY;

        if (width < 0) zoomRect.set('left', pointer.x);
        if (height < 0) zoomRect.set('top', pointer.y);
        zoomRect.set({ width: Math.abs(width), height: Math.abs(height) });
        canvas.renderAll();
    }
});

canvas.on('mouse:up', function(opt) {
    if (currentMode === 'zoom' && zoomRect) {
        if (zoomRect.width > 10 && zoomRect.height > 10) { // Evitar zoom en un simple clic
            const zoom = Math.min(
                canvas.width / zoomRect.width,
                canvas.height / zoomRect.height
            ) * 0.95; // 5% de margen
            
            canvas.zoomToPoint({ x: zoomRect.left + zoomRect.width / 2, y: zoomRect.top + zoomRect.height / 2 }, zoom);
            resetViewBtn.style.display = 'block'; // Mostrar el botón para restaurar
        }
        canvas.remove(zoomRect);
        zoomRect = null;
        enterSelectMode(); // Volver al modo selección automáticamente
    }
});

// --- FIN: NUEVO SISTEMA DE ZOOM ---

</script>
</body>
</html>